<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.80.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="最近遇到一个比较搞的问题，有关 linux 下的文件权限。因为发现解决问题之后的答案是我们很多工作多年的攻城狮以前都没有重视过的，所以特别写下来，帮助加"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="再学习 Linux 下的文件权限"><meta property="og:description" content="最近遇到一个比较搞的问题，有关 linux 下的文件权限。因为发现解决问题之后的答案是我们很多工作多年的攻城狮以前都没有重视过的，所以特别写下来，帮助加"><meta property="og:type" content="article"><meta property="og:url" content="http://i.am.simonkuang.org/posts/2015/10/22/%E5%86%8D%E5%AD%A6%E4%B9%A0-Linux-%E4%B8%8B%E7%9A%84%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/"><meta property="article:published_time" content="2015-10-22T10:37:23+00:00"><meta property="article:modified_time" content="2015-10-22T10:37:23+00:00"><title>再学习 Linux 下的文件权限 | 流沙书斋</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.90625d9fbb472b5f34fb5ba5842114a94d178eb68035d6dd2a9154e8b9bb1849.css integrity="sha256-kGJdn7tHK180+1ulhCEUqU0XjraANdbdKpFU6Lm7GEk="><script defer src=/en.search.min.1e8240e6ae2811912e6fdad8b3c953ce11f3b0b2fd0ecfc2fe6c89126a8d4b72.js integrity="sha256-HoJA5q4oEZEub9rYs8lTzhHzsLL9Ds/C/myJEmqNS3I="></script><script defer src=/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js integrity="sha256-dKi7B/C+6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script><script defer src=/custom.min.85e1dbc39b23671ffbf52bcb831b12735ade63896b28278cfb69b35d2c870ee9.js integrity="sha256-heHbw5sjZx/79SvLgxsSc1reY4lrKCeM+2mzXSyHDuk="></script><script src=//kit.fontawesome.com/e81509d074.js crossorigin=anonymous></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>流沙书斋</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/><i class="menu-item-icon fa fa-fw fa-home"></i>首页</a></li><li><a href=/posts/><i class="menu-item-icon fa fa-fw fa-blog"></i>博客</a></li><li><a href=/topics/><i class="menu-item-icon fa fa-fw fa-book"></i>专栏</a></li></ul><ul><li><a href=https://github.com/simonkuang target=_blank rel=noopener><i class="menu-item-icon fa fa-fw fa-github"></i>Github</a></li><li><a href=https://www.zhihu.com/people/simonkuang target=_blank rel=noopener><i class="menu-item-icon fab fa-fw fa-zhihu"></i>知乎</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>再学习 Linux 下的文件权限</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#背景>【背景】</a></li><li><a href=#关键信息>【关键信息】</a></li><li><a href=#现象>【现象】</a></li><li><a href=#解决的途径>【解决的途径】</a></li><li><a href=#答案>【答案】</a></li><li><a href=#解决办法>【解决办法】</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1><a href=/posts/2015/10/22/%E5%86%8D%E5%AD%A6%E4%B9%A0-Linux-%E4%B8%8B%E7%9A%84%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/>再学习 Linux 下的文件权限</a></h1><h5>2015-10-22</h5><div><a href=/tags/%E8%BF%90%E7%BB%B4/ class=tags>运维</a></div><p><p>最近遇到一个比较搞的问题，有关 linux 下的文件权限。因为发现解决问题之后的答案是我们很多工作多年的攻城狮以前都没有重视过的，所以特别写下来，帮助加深记忆。</p><h3 id=背景>【背景】
<a class=anchor href=#%e8%83%8c%e6%99%af>#</a></h3><p>同事学习 <code>lnmp</code>，搭好 <code>CentOS</code> 6.5 的环境之后，新建了一个用户组 <code>test</code>，在该组别下新建了一个用户 <code>test</code>，然后准备用这个用户模拟 <code>nginx</code> 和 <code>php-fpm</code> 进程的启动用户，跟着手册上做实践。</p><h3 id=关键信息>【关键信息】
<a class=anchor href=#%e5%85%b3%e9%94%ae%e4%bf%a1%e6%81%af>#</a></h3><ul><li>用户：<code>test:test</code></li><li>目录：<code>/www/test</code></li><li>目录权限：<code>drwxrwxrwx. 2 root root 40 Oct 21 16:43 test</code></li><li>文件：<code>/www/test/index.html</code></li><li>文件权限：<code>-rw-r--r--. 1 root root 0 Oct 22 10:04 index.html</code></li></ul><h3 id=现象>【现象】
<a class=anchor href=#%e7%8e%b0%e8%b1%a1>#</a></h3><ol><li>先用 <code>root</code> 的身份 <code>touch</code> 了一个空文件 <code>index.html</code>；</li><li><code>su test</code>，然后以 <code>test</code> 用户的身份去删除这个空文件；</li><li>WTF！！！ 竟然删除文件成功了？？？！！！</li></ol><p><strong>普通用户删除了 <code>root</code> 用户的文件</strong>，我保证，刚看到这个现象的时候，我内心绝对是崩溃的。</p><h3 id=解决的途径>【解决的途径】
<a class=anchor href=#%e8%a7%a3%e5%86%b3%e7%9a%84%e9%80%94%e5%be%84>#</a></h3><p>首先，检查了 <code>test</code> 用户的用户组，确认的确是 <code>test</code> 组。</p><p>其次，检查文件和目录的权限，除了 <code>test</code> 目录没有按照惯例，被设置成 <code>0777</code> 之外，没有什么特别的。不可能一个 <code>0777</code> 还能捣蛋吧？！</p><p>再次，<code>visudo</code> 命令检查有没有给 <code>test</code> 做高规格的授权。结论是：否。默认配置，没有可疑的配置。</p><p>接下来检查 <code>rm</code> 命令有没有被动过手脚。考虑到这是一台从 min 发行版正常安装起来的<strong>测试机</strong>，到这里我觉得已经有点儿过了。不过没关系，面对系统『问题』，谨慎一些总是好的。</p><p>之后又检查了 <code>uid</code> 和 <code>gid</code>，确保 <code>test:test</code> 没有占用一些有特殊作用的保留 id。</p><p>最后，还找不到问题，已经过去了半个多小时。猛然想起什么，试了一下除开 <code>test</code> 的其它用户，发现都能重现这个问题。至此发现问题的源头不在 <code>test</code> 这个用户身上。</p><h3 id=答案>【答案】
<a class=anchor href=#%e7%ad%94%e6%a1%88>#</a></h3><p>发现源头不在 <code>test</code> 用户身上之后，就走上了正路。如果不是用户或者用户组本身拥有超级权限，那么多半的多半，是权限本身的设计问题。</p><p>按经验，对客观存在的东西，<strong>不是 bug，就是一个 feature</strong>。</p><p>于是开始
<a href=http://www.itechzero.com/google-mirror-sites-collect.html>谷歌</a> Linux 文件权限相关的手册，终于终于找到了
<a href=http://vbird.dic.ksu.edu.tw/linux_basic/0210filepermission.php>鸟哥 Linux 私房菜——第六章、Linux 的文件权限及目录配置</a>（很奇怪，鸟哥的文档以简体形式放在宝岛学校的官网上），以及
<a href=https://en.wikipedia.org/wiki/Sticky_bit>Sticky bit</a> 的维基页。算是为这件事情做了一个注解。</p><p>鸟哥说：</p><blockquote><ul><li>权限对目录的重要性<ul><li>r (read contents in directory)：
……</li><li>w (modify contents of directory)：
这个可写入的权限对目录来说，是很了不起的！ 因为他表示你具有异动该目录结构列表的权限，也就是底下这些权限：<ul><li>建立新的文件与目录；</li><li>删除已经存在的文件与目录(不论该文件的权限为何！)</li><li>将已存在的文件或目录进行更名；</li><li>搬移该目录内的文件、目录位置。
总之，目录的w权限就与该目录底下的文件名异动有关就对了啦！</li></ul></li><li>x (access directory)：
……</li></ul></li></ul></blockquote><p>维基说：</p><blockquote><p>&mldr;
When a directory&rsquo;s sticky bit is set, the filesystem treats the files in such directories in a special way so only the file&rsquo;s owner, the directory&rsquo;s owner, or root can rename or delete the file. Without the sticky bit set, any user with write and execute permissions for the directory can rename or delete contained files, regardless of the file&rsquo;s owner.</p></blockquote><h3 id=解决办法>【解决办法】
<a class=anchor href=#%e8%a7%a3%e5%86%b3%e5%8a%9e%e6%b3%95>#</a></h3><ol><li>一定不要给多余的权限。这件事要养成习惯！任何可能接触到系统的人都要培养出来。</li><li>对于共用目录，一定要对这个目录激活 <code>sticky bit</code>。比如 <code>/tmp</code> 目录就默认激活了 <code>sticky bit</code> 的，这样大家共用这个目录也不会混乱。</li><li><code>sticky bit</code> 的限制不能继承，也就是说只对激活了 <code>sticky bit</code> 的当前目录有用。</li></ol></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#背景>【背景】</a></li><li><a href=#关键信息>【关键信息】</a></li><li><a href=#现象>【现象】</a></li><li><a href=#解决的途径>【解决的途径】</a></li><li><a href=#答案>【答案】</a></li><li><a href=#解决办法>【解决办法】</a></li></ul></li></ul></li></ul></nav></aside></main></body></html>