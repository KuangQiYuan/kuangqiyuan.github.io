<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.80.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="用 gitlab 很长一段时间了，从 2013 年开始，一直到现在，在每一个团队中都在推广使用 gitlab-ce 做版本管理和项目管理。本来一切好好的，一直到今天。 今天我要做备份的时"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Gitlab 备份时出现 Dumping MySQL FAILED 的错误"><meta property="og:description" content="用 gitlab 很长一段时间了，从 2013 年开始，一直到现在，在每一个团队中都在推广使用 gitlab-ce 做版本管理和项目管理。本来一切好好的，一直到今天。 今天我要做备份的时"><meta property="og:type" content="article"><meta property="og:url" content="http://i.am.simonkuang.org/posts/2015/10/29/Gitlab-%E5%A4%87%E4%BB%BD%E6%97%B6%E5%87%BA%E7%8E%B0-Dumping-MySQL-FAILED-%E7%9A%84%E9%94%99%E8%AF%AF/"><meta property="article:published_time" content="2015-10-29T12:17:22+00:00"><meta property="article:modified_time" content="2015-10-29T12:17:22+00:00"><title>Gitlab 备份时出现 Dumping MySQL FAILED 的错误 | 流沙书斋</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.90625d9fbb472b5f34fb5ba5842114a94d178eb68035d6dd2a9154e8b9bb1849.css integrity="sha256-kGJdn7tHK180+1ulhCEUqU0XjraANdbdKpFU6Lm7GEk="><script defer src=/en.search.min.bf8f257b7508161e115cfb596478cbb6de138c1c963ae8ff3ac42368dd0a92e3.js integrity="sha256-v48le3UIFh4RXPtZZHjLtt4TjByWOuj/OsQjaN0KkuM="></script><script defer src=/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js integrity="sha256-dKi7B/C+6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script><script defer src=/custom.min.85e1dbc39b23671ffbf52bcb831b12735ade63896b28278cfb69b35d2c870ee9.js integrity="sha256-heHbw5sjZx/79SvLgxsSc1reY4lrKCeM+2mzXSyHDuk="></script><script src=//kit.fontawesome.com/e81509d074.js crossorigin=anonymous></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>流沙书斋</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/><i class="menu-item-icon fa fa-fw fa-home"></i>首页</a></li><li><a href=/posts/><i class="menu-item-icon fa fa-fw fa-blog"></i>博客</a></li><li><a href=/topics/><i class="menu-item-icon fa fa-fw fa-book"></i>专栏</a></li></ul><ul><li><a href=https://github.com/simonkuang target=_blank rel=noopener><i class="menu-item-icon fa fa-fw fa-github"></i>Github</a></li><li><a href=https://www.zhihu.com/people/simonkuang target=_blank rel=noopener><i class="menu-item-icon fab fa-fw fa-zhihu"></i>知乎</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Gitlab 备份时出现 Dumping MySQL FAILED 的错误</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents></nav></aside></header><article class=markdown><h1><a href=/posts/2015/10/29/Gitlab-%E5%A4%87%E4%BB%BD%E6%97%B6%E5%87%BA%E7%8E%B0-Dumping-MySQL-FAILED-%E7%9A%84%E9%94%99%E8%AF%AF/>Gitlab 备份时出现 Dumping MySQL FAILED 的错误</a></h1><h5>2015-10-29</h5><div><a href=/tags/devops/ class=tags>devops</a></div><p><p>用
<a href=https://gitlab.com/>gitlab</a> 很长一段时间了，从 2013 年开始，一直到现在，在每一个团队中都在推广使用
<a href=https://gitlab.com/gitlab-org/gitlab-ce>gitlab-ce</a> 做版本管理和项目管理。本来一切好好的，一直到今天。</p><p>今天我要做备份的时候。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV<span style=color:#f92672>=</span>production
</code></pre></div><p>命令不灵了。</p><blockquote><p>Dumping database &mldr;
Dumping MySQL database gitlabhq_production &mldr; [FAILED]
Backup failed</p></blockquote><p><a href=http://guge.link>谷歌</a>了解决办法，无非下面几个情况：</p><ol><li>没有装 mysql client library。</li></ol><ul><li>解决办法：安装一个 mysql client library 就好。</li></ul><ol start=2><li><code>git</code> 用户没有写入 <code>config/gitlab.yml</code> 中设定的备份目录的权限</li></ol><ul><li>解决办法：修改备份目录所有者为 <code>git</code> 用户就好。</li></ul><ol start=3><li>官网上有 issue 是关于 <code>PostgreSQL</code> 的，没有结论，参考价值不大</li></ol><p>我挨个排查了一下，上面几种情况都排除了。</p><p>首先，我的 <code>gitlab</code> 站点完全正常访问， 所以第一种情况可以排除。</p><p>其次，<code>tmp/backups/db/</code> 目录下还有一个空文件 <code>database.sql</code>，我删除之后再试，它还能生成，证明备份 DB 的效果是有的，就是不知道为什么，没有取到 DB 里面的内容，备份成空文件了。顺便检查了下备份目录的磁盘空间，完全充足，用下面的命令证明 <code>git</code> 写入文件到备份目录是完全没有问题的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo -u git -H cat VERSION &gt; tmp/backups/db/test_VERSION
</code></pre></div><p>最后，运行 <code>check</code> 命令检查了 <code>gitlab</code> 的环境，一点儿问题都没有。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo -u git -H bundle exec rake gitlab:check RAILS_ENV<span style=color:#f92672>=</span>production
</code></pre></div><p>很奇怪对吧？仔细看了遍文档，没有答案。很明显几乎没人会遇到这种问题，因为大家提的 issue 就上面那几个，不是已经被证明与我遇到的情况不符，就是与我的实际情况无关。</p><p>然后，开动大脑，仔细想。。。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo -u git -H echo <span style=color:#e6db74>`</span>which mysqldump<span style=color:#e6db74>`</span>
</code></pre></div><blockquote><p>/usr/bin/which: no mysqldump in (<em>blabla&mldr;</em>)</p></blockquote><p>不知道对不对，试了下这个。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ln -s /usr/local/mysql/bin/mysqldump /usr/bin/mysqldump
</code></pre></div><p><strong>OK了！</strong></p><p>我就特别不喜欢那种假设各种工具都可以不需要指定路径直接调用的产品。特别是 gitlab 你都要我在配置文件里面指定 <code>git</code> 的全路径了，会用到 <code>mysqldump</code> 你也不说一声，悄悄咪咪地调用，出错也不直接出提示，只说『FAILED』。我去！</p><hr><p>后记：</p><ul><li>一开始还仔细检查了 <code>mysql</code> 的账号权限，才确信排除了数据库的问题；</li><li>对 <code>mysqldump</code> 的设置一开始是通过修改 <code>.bashrc</code> + 添加 <code>PATH</code> 到 <code>visudo</code> 的 <code>env_keep</code> 变量的方法来实现，最终确认问题的根源。建立软链接的方式从安全性上不太可取，不过实现成本最低，性价比高；</li><li>假如还不行，十多分钟后，我就准备开始读源码了。大约四五年前读过 <code>Ruby</code> 的代码，感觉不来电，倒是也不至于折磨人就是了。</li></ul></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents></nav></aside></main></body></html>